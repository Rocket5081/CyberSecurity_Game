<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cybersecurity Awareness Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f5f5f5;
        }

        .screen {
            display: none;
            width: 90%;
            max-width: 600px;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 2px solid #000;
            position: relative;
        }

        .active {
            display: block;
        }

        .screen-title {
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
        }

        /* Login/Register Specific Styles */
        .game-title {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: bold;
            text-align: left;
        }

        .game-logo {
            font-size: 18px;
            margin-bottom: 30px;
            text-align: center;
        }

        .login-form,
        .create-account-form {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 0 auto;
            max-width: 400px;
            background-color: #f9f9f9;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .form-links {
            text-align: left;
            margin-top: 10px;
        }

        .form-links a {
            display: block;
            color: #4CAF50;
            text-decoration: none;
            margin-bottom: 5px;
            cursor: pointer;
        }

        .password-strength {
            height: 5px;
            margin-top: 5px;
            background-color: #ddd;
            border-radius: 3px;
            position: relative;
        }

        .password-strength-indicator {
            height: 100%;
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s, background-color 0.3s;
        }

        /* Password Requirements Section */
        .password-requirements {
            margin: 15px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            text-align: left;
        }

        .password-requirements h3 {
            margin-top: 0;
            font-size: 16px;
        }

        .password-requirements ul {
            margin: 0;
            padding-left: 20px;
        }

        .password-requirements li {
            margin-bottom: 5px;
            font-size: 14px;
        }

        .password-requirements li.met {
            color: #4CAF50;
        }

        .password-requirements li.unmet {
            color: #F44336;
        }

        /* Button Styles */
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.3s;
            margin: 5px;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .secondary-button {
            background-color: #f1f1f1;
            color: #333;
        }

        .secondary-button:hover {
            background-color: #e0e0e0;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .error-message {
            color: red;
            text-align: left;
            margin-top: 5px;
            font-size: 14px;
            min-height: 20px;
        }

        .success-message {
            color: #4CAF50;
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 5px;
            display: none;
        }

        /* Close button in top-right corner */
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
            background: none;
            border: none;
            color: #999;
        }

        /* Game-specific styles */
        .question-container {
            text-align: left;
            margin-bottom: 20px;
        }

        .answer-option {
            text-align: left;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }

        .answer-option:hover {
            background-color: #f0f0f0;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .leaderboard-table th {
            background-color: #4CAF50;
            color: white;
        }

        .leaderboard-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .game-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: left;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .game-card:hover {
            transform: scale(1.02);
            background-color: #f9f9f9;
        }

        .difficulty {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            color: white;
        }



        .profile-info {
            text-align: left;
            margin-bottom: 20px;
        }

        .progress-container {
            width: 100%;
            background-color: #ddd;
            margin: 10px 0;
        }

        .progress-bar {
            height: 20px;
            background-color: #4CAF50;
            text-align: center;
            line-height: 20px;
            color: white;
        }

        /* Status bar for navigation */
        .status-bar {
            background-color: #333;
            color: white;
            padding: 10px;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 14px;
        }

        /* Category selection for game play */
        .category-selection {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .category-button {
            margin: 5px;
            padding: 10px 15px;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-button.selected {
            background-color: #4CAF50;
            color: white;
        }

        .question-number {
            font-weight: bold;
            color: #4CAF50;
        }

        .answer-option.correct {
            background-color: #e8f5e9;
            border-color: #4CAF50;
        }

        .answer-option.incorrect {
            background-color: #ffebee;
            border-color: #F44336;
        }

        /* Game difficulty indicator */
        .difficulty-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .difficulty-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: #ddd;
            display: inline-block;
        }

        .difficulty-dot.active {
            background-color: #4CAF50;
        }

        /* Online players container */
        .online-players-container {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            text-align: left;
        }

        #player-list {
            list-style-type: none;
            padding: 0;
        }

        #player-list li {
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }

        #player-list li.current-user {
            font-weight: bold;
            color: #4CAF50;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .challenge-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .challenge-button:hover {
            background-color: #45a049;
        }

        .chat-container {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            text-align: left;
        }

        #chat-messages {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: white;
            margin-bottom: 10px;
        }

        .chat-message {
            margin-bottom: 5px;
        }

        .own-message {
            color: #4CAF50;
        }

        .chat-input-container {
            display: flex;
        }

        #chat-input {
            flex-grow: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        #send-chat {
            margin-left: 5px;
        }

        .challenge-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .challenge-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            max-width: 400px;
            width: 80%;
        }

        .category-buttons {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }

        .modal-buttons {
            text-align: right;
        }

        .notification {
            position: fixed;
            bottom: 50px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s, transform 0.5s;
            z-index: 1000;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .achievement-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .achievement-popup-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 400px;
            width: 80%;
            text-align: center;
        }

        .achievement {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            text-align: left;
        }

        .achievement-icon {
            font-size: 30px;
            margin-right: 15px;
        }

        .achievement-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .achievement-description {
            font-size: 14px;
            color: #666;
        }

        /* Chat specific styles */
.chat-container {
    margin: 20px 0;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

#chat-messages {
    height: 200px;
    overflow-y: auto;
    padding: 10px;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 10px;
}

.chat-message {
    margin-bottom: 8px;
    padding: 5px;
    border-radius: 4px;
}

.own-message {
    background-color: #e8f5e9;
}

.chat-input-container {
    display: flex;
}

#chat-input {
    flex-grow: 1;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px 0 0 4px;
}

#send-chat {
    padding: 8px 15px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 0 4px 4px 0;
    cursor: pointer;
}

#send-chat:hover {
    background-color: #45a049;
}
    </style>
</head>

<body>
    <!-- Splash Page -->
    <div id="splash-page" class="screen active">
        <div class="screen-title">Cybersecurity Awareness Game</div>
        <div class="game-logo" style="font-size: 40px; margin: 50px 0;">🔒</div>
        <p>Loading game resources...</p>
        <div class="progress-container">
            <div class="progress-bar" id="loading-progress" style="width:0%">0%</div>
        </div>

        <div class="button-group" style="justify-content: center; margin-top: 50px;">
            <button onclick="switchScreen('login-register')">Skip to Login</button>
        </div>
    </div>

    <!-- Login/Register Screen -->
    <div id="login-register" class="screen">
        <div class="game-title">Cybersecurity Awareness Game</div>
        <div class="game-logo">Game Logo</div>

        <div class="login-form">
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username">
                <div class="error-message" id="username-error"></div>
            </div>

            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password">
                <div class="password-strength">
                    <div class="password-strength-indicator" id="password-strength-indicator"></div>
                </div>
                <div class="error-message" id="password-error"></div>
            </div>

            <div class="form-links">
                <a id="forgot-password">Forgot Password</a>
                <button id="login-button" style="margin-top: 10px; width: 100%;">Login</button>
            </div>
        </div>

        <div class="button-group">
            <button id="create-account-btn" onclick="switchScreen('create-account-screen')">Create Account</button>
            <button id="guest-play">Play as Guest</button>
        </div>

        <div class="error-message" id="login-error"></div>
    </div>

    <!-- Create Account Screen -->
    <div id="create-account-screen" class="screen">
        <!-- Close button -->
        <button class="close-button" onclick="switchScreen('login-register')">[x]</button>

        <div class="game-title">Create Account</div>

        <div class="create-account-form">
            <div class="form-group">
                <label for="create-username">Username:</label>
                <input type="text" id="create-username" name="username">
                <div class="error-message" id="create-username-error"></div>
            </div>

            <div class="form-group">
                <label for="create-email">Email:</label>
                <input type="email" id="create-email" name="email">
                <div class="error-message" id="create-email-error"></div>
            </div>

            <div class="form-group">
                <label for="create-password">Password:</label>
                <input type="password" id="create-password" name="password">
                <div class="password-strength">
                    <div class="password-strength-indicator" id="create-password-strength"></div>
                </div>
                <div class="error-message" id="create-password-error"></div>
            </div>

            <div class="password-requirements">
                <h3>Password Requirements:</h3>
                <ul id="requirements-list">
                    <li id="req-length" class="unmet">At least 10 characters</li>
                    <li id="req-uppercase" class="unmet">At least 1 uppercase character</li>
                    <li id="req-lowercase" class="unmet">At least 1 lowercase character</li>
                    <li id="req-number" class="unmet">At least 1 number</li>
                    <li id="req-special" class="unmet">At least 1 special character</li>
                </ul>
            </div>

            <div class="success-message" id="create-success-message"></div>
        </div>

        <div class="button-group">
            <button id="create-account-submit" disabled>Create Account</button>
            <button class="secondary-button" onclick="switchScreen('login-register')">Back to Login</button>
        </div>
    </div>

    <!-- Main Menu Screen -->
    <div id="main-menu" class="screen">
        <div class="screen-title">Main Menu</div>
        <div class="game-logo" style="font-size: 30px; margin: 20px 0;">🔒</div>

        <p>Welcome to the Cybersecurity Awareness Game!</p>
        <p id="welcome-message">Test your knowledge about cybersecurity threats and protections.</p>

        <div style="margin-top: 30px;">
            <button onclick="switchScreen('game-selection')" style="width: 200px; margin: 10px;">Play Game</button>
            <button onclick="switchScreen('user-profile')" style="width: 200px; margin: 10px;">User Profile</button>
            <button onclick="switchScreen('leaderboard')" style="width: 200px; margin: 10px;">Leaderboard</button>
            <button data-action="logout" style="width: 200px; margin: 10px;">Logout</button>
        </div>
    </div>

    <!-- Game Selection Screen -->
    <div id="game-selection" class="screen">
        <div class="screen-title">Game Selection</div>
        <p>Choose a cybersecurity scenario to play:</p>

        <div class="game-card" onclick="startGame('Phishing Defense')">
            <h3>Phishing Attacks</h3>
            <p>Learn to identify and avoid phishing attempts.</p>
        </div>

        <div class="game-card" onclick="startGame('Social Engineering')">
            <h3>Social Engineering</h3>
            <p>Learn to identify and avoid social engineering attempts.</p>
        </div>

        <div class="game-card" onclick="startGame('Password Security')">
            <h3>Mobile Device Security</h3>
            <p>Protecting your smartphone from various threats.</p>
        </div>

        <div class="button-group" style="justify-content: center; margin-top: 20px;">
            <button onclick="switchScreen('main-menu')">Back to Menu</button>
        </div>
    </div>

    <!-- User Profile Screen -->
    <div id="user-profile" class="screen">
        <div class="screen-title">User Profile</div>

        <div class="profile-info">
            <h3>User Information</h3>
            <p><strong>Username:</strong> <span id="profile-username">CyberDefender</span></p>
            <p><strong>Join Date:</strong> <span id="profile-join-date">February 15, 2025</span></p>
            <p><strong>Games Played:</strong> <span id="profile-games-played">12</span></p>
            <p><strong>High Score:</strong> <span id="profile-high-score">850</span></p>

            <h3>Performance Statistics</h3>
            <p><strong>Phishing Knowledge:</strong></p>
            <div class="progress-container">
                <div class="progress-bar" id="profile-phishing-progress" style="width:75%">75%</div>
            </div>

            <p><strong>Social Engineering:</strong></p>
            <div class="progress-container">
                <div class="progress-bar" id="profile-social-progress" style="width:90%">90%</div>
            </div>

            <p><strong>Mobile Security:</strong></p>
            <div class="progress-container">
                <div class="progress-bar" id="profile-mobile-progress" style="width:60%">60%</div>
            </div>
        </div>

        <div class="button-group">
            <button onclick="switchScreen('game-selection')">Play Game</button>
            <button onclick="switchScreen('leaderboard')">View Leaderboard</button>
            <button onclick="switchScreen('main-menu')">Back to Menu</button>
        </div>
    </div>

    <!-- Game Play Screen -->
    <div id="game-play" class="screen">
        <div class="screen-title" id="game-play-title">Cybersecurity Quiz</div>

        <div class="difficulty-indicator">
            <span id="difficulty-text">Difficulty:</span>
            <div>
                <span class="difficulty-dot" id="diff-1"></span>
                <span class="difficulty-dot" id="diff-2"></span>
                <span class="difficulty-dot" id="diff-3"></span>
            </div>
        </div>

        <div class="question-container">
            <h3>Question <span id="question-number">1</span>:</h3>
            <p id="question-text">Loading question...</p>
        </div>

        <div class="answer-option" id="option-a" onclick="selectAnswer('a')">A. Loading option...</div>
        <div class="answer-option" id="option-b" onclick="selectAnswer('b')">B. Loading option...</div>
        <div class="answer-option" id="option-c" onclick="selectAnswer('c')">C. Loading option...</div>
        <div class="answer-option" id="option-d" onclick="selectAnswer('d')">D. Loading option...</div>

        <div id="answer-feedback" style="margin: 20px 0; display: none; padding: 10px; border-radius: 5px;"></div>

        <div class="button-group" style="justify-content: space-between;">
            <div>
                <span>Score: <strong id="current-score">0</strong></span>
                <span style="margin-left: 20px;">Time: <strong id="time-remaining">60</strong>s</span>
            </div>
            <button id="next-question" style="display: none;" onclick="nextQuestion()">Next Question</button>
            <button onclick="endGame()">End Game</button>
        </div>
    </div>

    <!-- Leaderboard Screen -->
    <div id="leaderboard" class="screen">
        <div class="screen-title">Leaderboard</div>

        <table class="leaderboard-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Player</th>
                    <th>Score</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                <!-- Leaderboard entries will be populated dynamically -->
            </tbody>
        </table>

        <div style="margin-top: 20px; text-align: left; padding: 10px; background-color: #e8f5e9; border-radius: 5px;">
            <p><strong>Your Rank:</strong> <span id="user-rank">Not ranked yet</span></p>
        </div>

        <div class="button-group">
            <button onclick="switchScreen('game-selection')">Play Again</button>
            <button onclick="switchScreen('user-profile')">View Profile</button>
            <button onclick="switchScreen('main-menu')">Back to Menu</button>
        </div>
    </div>

    <!-- Game Results Screen -->
    <div id="game-results" class="screen">
        <div class="screen-title">Game Results</div>

        <div style="margin: 20px 0; padding: 20px; background-color: #e8f5e9; border-radius: 10px;">
            <h2>Your Score: <span id="final-score">750</span></h2>
            <p>Correct Answers: <span id="correct-answers">15/20</span> (<span id="correct-percentage">75</span>%)</p>

            <h3>Performance Summary:</h3>
            <p id="category-performance">Category: <span id="played-category">Phishing Awareness</span></p>
            <div class="progress-container">
                <div class="progress-bar" id="category-progress" style="width:80%">80%</div>
            </div>

            <p>Questions by Difficulty:</p>
            <p>Easy: <span id="easy-stats">3/3</span></p>
            <p>Medium: <span id="medium-stats">2/3</span></p>
            <p>Hard: <span id="hard-stats">1/3</span></p>
        </div>

        <div style="text-align: left; margin: 20px 0;">
            <h3>Recommendations:</h3>
            <div id="recommendations">
                <!-- Recommendations will be populated dynamically -->
            </div>
        </div>

        <div class="button-group">
            <button onclick="switchScreen('game-selection')">Play Again</button>
            <button onclick="switchScreen('leaderboard')">View Leaderboard</button>
            <button onclick="switchScreen('main-menu')">Back to Main Menu</button>
        </div>
    </div>

    <!-- Navigation Status Bar -->
    <div class="status-bar">
        Current Screen: <span id="current-screen">Splash Page</span>
    </div>

    <!-- Socket.io library -->
    <script src="/socket.io/socket.io.js"></script>

    <script>
        // Initialize socket connection
        const socket = io();

        // Game state variables
        let currentUser = null;
        let currentScore = 0;
        let timeRemaining = 60;
        let gameTimer;
        let currentQuestion = 0;
        let correctAnswers = 0;
        let currentCategory = '';
        let currentQuestions = [];
        let selectedDifficulty = '';
        let easyCorrect = 0, mediumCorrect = 0, hardCorrect = 0;
        let easyTotal = 0, mediumTotal = 0, hardTotal = 0;
        let onlinePlayers = [];

        // On document ready
        document.addEventListener('DOMContentLoaded', function () {
            // Setup event listeners
            setupEventListeners();

            // Socket event handlers
            setupSocketHandlers();

            // Simulating splash screen loading
            simulateSplashScreenLoading();

            // Set up password strength meter
            document.getElementById('create-password').addEventListener('input', checkPasswordStrength);

            // Initialize multiplayer features
            initMultiplayer();

            // Set up achievements
            setupAchievements();
        });

        // Setup socket event handlers
        function setupSocketHandlers() {
            // Handle registration response
            socket.on('registrationResponse', (response) => {
                if (response.success) {
                    currentUser = response.user;

                    // Show success message
                    const successMessage = document.getElementById('create-success-message');
                    successMessage.textContent = 'Account created successfully!';
                    successMessage.style.display = 'block';

                    // Clear form
                    document.getElementById('create-username').value = '';
                    document.getElementById('create-email').value = '';
                    document.getElementById('create-password').value = '';

                    // Reset password strength
                    document.getElementById('create-password-strength').style.width = '0%';
                    document.querySelectorAll('#requirements-list li').forEach(li => {
                        li.className = 'unmet';
                    });

                    // Redirect to login after a delay
                    setTimeout(function () {
                        switchScreen('login-register');
                    }, 2000);
                } else {
                    // Show error message
                    document.getElementById('create-username-error').textContent = response.message;
                }
            });

            // Handle login response
            // Handle login response
            socket.on('loginResponse', (response) => {
                if (response.success) {
                    currentUser = response.user;

                    // Update welcome message
                    document.getElementById('welcome-message').textContent =
                        `Welcome, ${currentUser.username}! Test your knowledge about cybersecurity threats and protections.`;

                    // Update profile page
                    updateProfilePage();

                    // Switch to main menu
                    switchScreen('main-menu');
                } else {
                    // Show error message
                    const loginError = document.getElementById('login-error');
                    const loginButton = document.getElementById('login-button');
                    loginError.textContent = response.message || 'Invalid username or password';
        
                    // If the account is locked, start a countdown timer
                    if (response.lockTimeRemaining) {
                        // Disable the login button during lockout
                        loginButton.disabled = true;
            
                        let timeRemaining = response.lockTimeRemaining;
                        const countdownInterval = setInterval(() => {
                            timeRemaining--;
                            loginError.textContent = `Account locked. Try again in ${timeRemaining} seconds.`;
                
                            if (timeRemaining <= 0) {
                                clearInterval(countdownInterval);
                                loginButton.disabled = false;
                                loginError.textContent = 'Account unlocked. You may try again.';
                            }
                        }, 1000);
                    }
               }
            });

            // Handle player update (online players)
            socket.on('playerUpdate', (data) => {
                onlinePlayers = data.players;
                // You could display online players in a sidebar or in the main menu
                console.log('Online players:', onlinePlayers);
            });

            // Handle leaderboard update
            socket.on('leaderboardUpdated', (data) => {
                updateLeaderboardDisplay(data.leaderboard);
            });

            // Handle leaderboard data
            socket.on('leaderboardData', (data) => {
                updateLeaderboardDisplay(data.leaderboard);
            });

            // Handle user data update
            socket.on('userUpdated', (data) => {
                // Update the current user object with new data
                currentUser = { ...currentUser, ...data.user };

                // Update the profile if currently viewing it
                if (document.getElementById('user-profile').classList.contains('active')) {
                    updateProfilePage();
                }
            });

            // Handle question data
            socket.on('questionsData', (data) => {
    console.log("Received questions from server:", data);

    if (data.questions && data.questions.length > 0) {
        // Randomize the questions array
        currentQuestions = shuffleArray([...data.questions]);
        console.log("Questions randomized:", currentQuestions);

        // Re-enable answer options
        document.querySelectorAll('.answer-option').forEach(option => {
            option.style.pointerEvents = "auto";
        });

        // Start with the first question
        loadQuestion(0);
    } else {
        // Handle case where no questions were returned
        document.getElementById('question-text').textContent =
            "No questions available for this category. Please try another category.";

        // Add a back button
        const feedbackDiv = document.getElementById('answer-feedback');
        feedbackDiv.style.display = 'block';
        feedbackDiv.style.backgroundColor = '#ffebee';
        feedbackDiv.innerHTML =
            'No questions found. <button onclick="switchScreen(\'game-selection\')">Back to Categories</button>';
                }
            });

            // Handle question error
            socket.on('questionsError', (data) => {
                alert('Error loading questions: ' + data.message);
                switchScreen('game-selection');
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Create account button event
            document.getElementById('create-account-submit').addEventListener('click', function () {
                const username = document.getElementById('create-username').value;
                const email = document.getElementById('create-email').value;
                const password = document.getElementById('create-password').value;

                if (!username || !email || !password) {
                    document.getElementById('create-username-error').textContent = 'All fields are required';
                    return;
                }

                // Send registration request to server
                socket.emit('registerUser', {
                    username: username,
                    email: email,
                    password: password
                });
            });

            // Login button event
            document.getElementById('login-button').addEventListener('click', function () {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                if (!username || !password) {
                    document.getElementById('login-error').textContent = 'Username and password are required';
                    return;
                }

                // Send login request to server
                socket.emit('login', {
                    username: username,
                    password: password
                });
            });

            // Guest login button
            document.getElementById('guest-play').addEventListener('click', loginAsGuest);

            // Password input for login - strength meter
            document.getElementById('password').addEventListener('input', function () {
                const password = this.value;
                const strengthIndicator = document.getElementById('password-strength-indicator');

                // Simple strength calculation for login screen
                let strength = 0;
                if (password.length > 5) strength += 20;
                if (password.length > 10) strength += 20;
                if (/[A-Z]/.test(password)) strength += 20;
                if (/[0-9]/.test(password)) strength += 20;
                if (/[^A-Za-z0-9]/.test(password)) strength += 20;

                strengthIndicator.style.width = strength + '%';

                if (strength < 40) {
                    strengthIndicator.style.backgroundColor = '#F44336';
                } else if (strength < 80) {
                    strengthIndicator.style.backgroundColor = '#FFC107';
                } else {
                    strengthIndicator.style.backgroundColor = '#4CAF50';
                }
            });

            // Logout functionality
            const logoutButtons = document.querySelectorAll('[data-action="logout"]');
            logoutButtons.forEach(button => {
                button.addEventListener('click', function () {
                    // Send logout request to server
                    socket.emit('logout');
                    currentUser = null;
                    switchScreen('login-register');
                });
            });
        }

        // Simulate splash screen loading
        function simulateSplashScreenLoading() {
            let progress = 0;
            const interval = setInterval(function () {
                progress += 10;
                document.getElementById('loading-progress').style.width = progress + '%';
                document.getElementById('loading-progress').innerText = progress + '%';

                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(function () {
                        switchScreen('login-register');
                    }, 500);
                }
            }, 300);
        }

        // Switch between screens
        function switchScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });

            // Show the selected screen
            document.getElementById(screenId).classList.add('active');

            // Update current screen display - with null check
            const screenTitleElement = document.querySelector(`#${screenId} .screen-title`);
            if (screenTitleElement) {
                document.getElementById('current-screen').textContent = screenTitleElement.textContent;
            } else {
                // Fallback to a formatted version of the screen ID if no title element is found
                document.getElementById('current-screen').textContent =
                    screenId.charAt(0).toUpperCase() + screenId.slice(1).replace(/-/g, ' ');
            }

            // Special screen handling
            if (screenId === 'game-play') {
                startGameTimer();
            } else if (screenId === 'leaderboard') {
                // Request latest leaderboard data
                socket.emit('getLeaderboard');
            } else if (screenId === 'user-profile') {
                // Update profile information when viewing profile
                updateProfilePage();
            } else {
                // If leaving game play, clear the timer
                if (gameTimer) {
                    clearInterval(gameTimer);
                }
            }
        }

        // Login as guest
        function loginAsGuest() {
            socket.emit('guestLogin');
        }

        // Update leaderboard display
        function updateLeaderboardDisplay(leaderboard) {
            const leaderboardTable = document.querySelector('.leaderboard-table tbody');

            // Clear existing rows
            leaderboardTable.innerHTML = '';

            // Add new rows
            leaderboard.forEach((entry, index) => {
                const row = document.createElement('tr');

                const rankCell = document.createElement('td');
                const playerCell = document.createElement('td');
                const scoreCell = document.createElement('td');
                const dateCell = document.createElement('td');

                rankCell.textContent = index + 1;
                playerCell.textContent = entry.username;
                scoreCell.textContent = entry.score;
                dateCell.textContent = new Date(entry.date).toLocaleDateString();

                row.appendChild(rankCell);
                row.appendChild(playerCell);
                row.appendChild(scoreCell);
                row.appendChild(dateCell);

                // Highlight current user
                if (currentUser && entry.username === currentUser.username) {
                    row.style.backgroundColor = '#e8f5e9';
                }

                leaderboardTable.appendChild(row);
            });

            // Update personal rank info
            if (currentUser) {
                const userRank = leaderboard.findIndex(entry => entry.username === currentUser.username);
                const rankText = document.querySelector('#user-rank');

                if (userRank !== -1) {
                    rankText.innerHTML = `#${userRank + 1} (Score: ${leaderboard[userRank].score})`;
                } else {
                    rankText.innerHTML = `Not ranked yet`;
                }
            }
        }

        // Update profile page with user data
        function updateProfilePage() {
            if (!currentUser) return;

            document.getElementById('profile-username').textContent = currentUser.username;
            document.getElementById('profile-join-date').textContent = new Date(currentUser.registrationDate).toLocaleDateString();
            document.getElementById('profile-games-played').textContent = currentUser.gamesPlayed || 0;
            document.getElementById('profile-high-score').textContent = currentUser.highscore || 0;

            // Update category progress bars
            const phishingBar = document.getElementById('profile-phishing-progress');
            const socialBar = document.getElementById('profile-social-progress');
            const mobileBar = document.getElementById('profile-mobile-progress');

            if (currentUser.categoryProgress) {
                const phishingProgress = currentUser.categoryProgress.phishing || 0;
                const socialProgress = currentUser.categoryProgress.social || 0;
                const mobileProgress = currentUser.categoryProgress.mobile || 0;

                phishingBar.style.width = phishingProgress + '%';
                phishingBar.textContent = phishingProgress + '%';

                socialBar.style.width = socialProgress + '%';
                socialBar.textContent = socialProgress + '%';

                mobileBar.style.width = mobileProgress + '%';
                mobileBar.textContent = mobileProgress + '%';
            }
        }

        // Check password strength
        function checkPasswordStrength() {
            const password = document.getElementById('create-password').value;
            const strengthIndicator = document.getElementById('create-password-strength');
            const createButton = document.getElementById('create-account-submit');

            // Check requirements
            const requirements = {
                length: password.length >= 10,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /[0-9]/.test(password),
                special: /[^A-Za-z0-9]/.test(password)
            };

            // Update requirement list
            document.getElementById('req-length').className = requirements.length ? 'met' : 'unmet';
            document.getElementById('req-uppercase').className = requirements.uppercase ? 'met' : 'unmet';
            document.getElementById('req-lowercase').className = requirements.lowercase ? 'met' : 'unmet';
            document.getElementById('req-number').className = requirements.number ? 'met' : 'unmet';
            document.getElementById('req-special').className = requirements.special ? 'met' : 'unmet';

            // Calculate strength percentage
            let strengthPoints = 0;
            Object.values(requirements).forEach(req => {
                if (req) strengthPoints++;
            });

            const strengthPercentage = (strengthPoints / 5) * 100;

            // Update strength indicator
            strengthIndicator.style.width = strengthPercentage + '%';

            // Set color based on strength
            if (strengthPercentage < 40) {
                strengthIndicator.style.backgroundColor = '#F44336'; // Red
            } else if (strengthPercentage < 80) {
                strengthIndicator.style.backgroundColor = '#FFC107'; // Yellow
            } else {
                strengthIndicator.style.backgroundColor = '#4CAF50'; // Green
            }

            // Enable or disable create button
            createButton.disabled = strengthPercentage < 100;
        }

        // Start game with selected category
        function startGame(category) {
            currentCategory = category;
            document.getElementById('game-play-title').textContent =
                category.charAt(0).toUpperCase() + category.slice(1) + ' Security Quiz';

            // Reset game stats
            currentScore = 0;
            timeRemaining = 60;
            currentQuestion = 0;
            correctAnswers = 0;
            easyCorrect = 0;
            mediumCorrect = 0;
            hardCorrect = 0;
            easyTotal = 0;
            mediumTotal = 0;
            hardTotal = 0;

            // Update score display
            document.getElementById('current-score').textContent = currentScore;

            // Show loading message
            document.getElementById('question-text').textContent = "Loading questions...";
            document.querySelectorAll('.answer-option').forEach(option => {
                option.textContent = "Loading...";
                option.style.pointerEvents = "none"; // Disable clicking
            });

            // Switch to game screen
            switchScreen('game-play');

            // Request questions from server
            console.log("Requesting questions for category:", category);
            socket.emit('getQuestions', { category: category });
        }

        // Load a question
        function loadQuestion(index) {
            if (!currentQuestions || currentQuestions.length === 0) {
                console.error("No questions available");
                return;
            }

            if (index < currentQuestions.length) {
                const question = currentQuestions[index];

                // Reset option classes
                document.querySelectorAll('.answer-option').forEach(option => {
                    option.className = 'answer-option';
                });

                // Hide feedback and next button
                document.getElementById('answer-feedback').style.display = 'none';
                document.getElementById('next-question').style.display = 'none';

                // Set question text
                document.getElementById('question-number').textContent = index + 1;
                document.getElementById('question-text').textContent = question.QuestionText;

                // Get the answers for this question
                const answers = question.answers;

                if (!answers || answers.length < 4) {
                    console.error("Not enough answers for question:", question);
                    document.getElementById('answer-feedback').style.display = 'block';
                    document.getElementById('answer-feedback').style.backgroundColor = '#ffebee';
                    document.getElementById('answer-feedback').textContent =
                        "Error: This question doesn't have enough answer options.";
                    return;
                }

                // Map answers to options a, b, c, d
                const optionMap = ['a', 'b', 'c', 'd'];

                // Set options
                answers.forEach((answer, i) => {
                    if (i < 4) {
                        const option = optionMap[i];
                        document.getElementById('option-' + option).textContent =
                            option.toUpperCase() + '. ' + answer.AnswerText;

                        // Store the correct answer
                        if (answer.isCorrect) {
                            question.correctAnswer = option;
                        }
                    }
                });

                // Update difficulty indicator
                updateDifficultyIndicator(question.Difficulty);

                // Track difficulty totals
                if (question.Difficulty === 'easy') easyTotal++;
                if (question.Difficulty === 'medium') mediumTotal++;
                if (question.Difficulty === 'hard') hardTotal++;
            } else {
                // No more questions, end the game
                endGame();
            }
        }

        // Update difficulty indicator
        function updateDifficultyIndicator(difficulty) {
            const dot1 = document.getElementById('diff-1');
            const dot2 = document.getElementById('diff-2');
            const dot3 = document.getElementById('diff-3');

            // Reset all dots
            dot1.className = 'difficulty-dot';
            dot2.className = 'difficulty-dot';
            dot3.className = 'difficulty-dot';

            // Set active dots based on difficulty
            if (difficulty === 'easy') {
                dot1.className = 'difficulty-dot active';
                document.getElementById('difficulty-text').textContent = 'Difficulty: Easy';
            } else if (difficulty === 'medium') {
                dot1.className = 'difficulty-dot active';
                dot2.className = 'difficulty-dot active';
                document.getElementById('difficulty-text').textContent = 'Difficulty: Medium';
            } else if (difficulty === 'hard') {
                dot1.className = 'difficulty-dot active';
                dot2.className = 'difficulty-dot active';
                dot3.className = 'difficulty-dot active';
                document.getElementById('difficulty-text').textContent = 'Difficulty: Hard';
            }
        }

        // Handle answer selection
        function selectAnswer(option) {
            // Prevent selecting an answer if feedback is already shown
            if (document.getElementById('answer-feedback').style.display !== 'none') {
                return;
            }

            const question = currentQuestions[currentQuestion];
            const selectedOption = document.getElementById('option-' + option);
            const feedback = document.getElementById('answer-feedback');

            // Show the correct answer
            document.getElementById('option-' + question.correctAnswer).classList.add('correct');

            if (option === question.correctAnswer) {
                // Correct answer
                selectedOption.classList.add('correct');
                feedback.style.backgroundColor = '#e8f5e9';

                // Find the explanation text (use the correct answer's text as explanation for now)
                const explanation = "Correct! That's the right answer.";
                feedback.textContent = explanation;

                // Award points based on difficulty
                let points = 10;
                if (question.Difficulty === 'medium') points = 20;
                if (question.Difficulty === 'hard') points = 30;

                currentScore += points;
                document.getElementById('current-score').textContent = currentScore;

                correctAnswers++;

                // Track difficulty stats
                if (question.Difficulty === 'easy') easyCorrect++;
                if (question.Difficulty === 'medium') mediumCorrect++;
                if (question.Difficulty === 'hard') hardCorrect++;
            } else {
                // Incorrect answer
                selectedOption.classList.add('incorrect');
                feedback.style.backgroundColor = '#ffebee';

                // Find the explanation text
                const explanation = "Incorrect. Please try again.";
                feedback.textContent = explanation;
            }

            // Show feedback and next button
            feedback.style.display = 'block';
            document.getElementById('next-question').style.display = 'block';
        }

        // Move to next question
        function nextQuestion() {
            currentQuestion++;
            loadQuestion(currentQuestion);
        }

        // Start the game timer
        function startGameTimer() {
            // Reset timer
            timeRemaining = 60;
            document.getElementById('time-remaining').textContent = timeRemaining;

            // Clear any existing timer
            if (gameTimer) {
                clearInterval(gameTimer);
            }

            // Set up new timer
            gameTimer = setInterval(function () {
                timeRemaining--;
                document.getElementById('time-remaining').textContent = timeRemaining;

                if (timeRemaining <= 0) {
                    clearInterval(gameTimer);
                    endGame();
                }
            }, 1000);
        }

        // End the game
        function endGame() {
            // Clear timer
            if (gameTimer) {
                clearInterval(gameTimer);
            }

            // Apply time bonus if there's remaining time
            if (timeRemaining > 0) {
                // Calculate time bonus - multiply score by a factor based on remaining time
                const timeBonusFactor = 1 + (timeRemaining / 60);

                // Apply the bonus
                const originalScore = currentScore;
                currentScore = Math.round(originalScore * timeBonusFactor);

                console.log(`Time bonus applied: ${originalScore} × ${timeBonusFactor.toFixed(2)} = ${currentScore}`);
            }

            // Calculate percentage of correct answers
            const percentage = Math.round((correctAnswers / currentQuestions.length) * 100);

            // Update results screen
            document.getElementById('final-score').textContent = currentScore;
            document.getElementById('correct-answers').textContent = correctAnswers + '/' + currentQuestions.length;
            document.getElementById('correct-percentage').textContent = percentage;
            document.getElementById('category-progress').style.width = percentage + '%';
            document.getElementById('category-progress').textContent = percentage + '%';

            document.getElementById('played-category').textContent =
                currentCategory.charAt(0).toUpperCase() + currentCategory.slice(1) + ' Security';

            // Update difficulty stats
            document.getElementById('easy-stats').textContent = easyCorrect + '/' + easyTotal;
            document.getElementById('medium-stats').textContent = mediumCorrect + '/' + mediumTotal;
            document.getElementById('hard-stats').textContent = hardCorrect + '/' + hardTotal;

            // Add time bonus information to recommendations
            if (timeRemaining > 0) {
                const bonusMessage = document.createElement('p');
                bonusMessage.innerHTML = `<strong>Time Bonus!</strong> You completed the quiz with ${timeRemaining} seconds remaining, earning a ${((timeRemaining / 60) * 100).toFixed(0)}% score bonus!`;
                bonusMessage.style.color = '#4CAF50';
                document.getElementById('recommendations').prepend(bonusMessage);
            }

            // Generate personalized recommendations
            generateRecommendations();

            // Send game results to server
            if (currentUser && !currentUser.isGuest) {
                socket.emit('gameCompleted', {
                    category: currentCategory,
                    score: currentScore,
                    correctAnswers: correctAnswers,
                    totalQuestions: currentQuestions.length,
                    progressPercent: percentage,
                    difficulty: {
                        easy: { correct: easyCorrect, total: easyTotal },
                        medium: { correct: mediumCorrect, total: mediumTotal },
                        hard: { correct: hardCorrect, total: hardTotal }
                    }
                });

                // Update local user data if new score is higher
                if (currentScore > (currentUser.highscore || 0)) {
                    currentUser.highscore = currentScore;
                }

                // Increment games played locally to show immediately
                currentUser.gamesPlayed = (currentUser.gamesPlayed || 0) + 1;

                // Update profile page in case user navigates there
                updateProfilePage();
            }

            // Switch to results screen
            switchScreen('game-results');
        }

        // Generate personalized recommendations based on performance
        function generateRecommendations() {
            const recommendationsDiv = document.getElementById('recommendations');
            recommendationsDiv.innerHTML = '';

            const recommendations = [];

            if (easyCorrect < easyTotal) {
                recommendations.push('• Review basic ' + currentCategory + ' security concepts');
            }

            if (mediumCorrect < mediumTotal) {
                recommendations.push('• Practice identifying more complex ' + currentCategory + ' security threats');
            }

            if (hardCorrect < hardTotal) {
                recommendations.push('• Learn advanced techniques for ' + currentCategory + ' attack prevention');
            }

            // Add some generic recommendations
            recommendations.push('• Try our other security categories to improve your overall awareness');
            recommendations.push('• Consider setting up two-factor authentication for your important accounts');

            // Add recommendations to the div
            recommendations.forEach(rec => {
                const p = document.createElement('p');
                p.textContent = rec;
                recommendationsDiv.appendChild(p);
            });
        }

        // Utility function to shuffle an array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Add multiplayer functionality
        function setupMultiplayerFeatures() {
            // Create a player list element (this could be added to the sidebar or main menu)
            const playerListContainer = document.createElement('div');
            playerListContainer.id = 'online-players';
            playerListContainer.className = 'online-players-container';
            playerListContainer.innerHTML = `
                <h3>Online Players</h3>
                <ul id="player-list"></ul>
            `;

            // Add to main menu
            const mainMenu = document.getElementById('main-menu');
            mainMenu.appendChild(playerListContainer);

            // Update player list when it changes
            socket.on('playerUpdate', (data) => {
                const playerList = document.getElementById('player-list');
                playerList.innerHTML = '';

                data.players.forEach(player => {
                    const li = document.createElement('li');
                    li.textContent = player;

                    // Highlight current user
                    if (currentUser && player === currentUser.username) {
                        li.className = 'current-user';
                    }

                    playerList.appendChild(li);
                });
            });

            // Add challenge functionality
            socket.on('challengeRequest', (data) => {
                if (confirm(`${data.challenger} has challenged you to a ${data.category} quiz! Accept?`)) {
                    socket.emit('acceptChallenge', { challenger: data.challenger });
                    startGame(data.category);
                } else {
                    socket.emit('declineChallenge', { challenger: data.challenger });
                }
            });

            // Add chat functionality
            const chatContainer = document.createElement('div');
            chatContainer.id = 'chat-container';
            chatContainer.className = 'chat-container';
            chatContainer.innerHTML = `
                <h3>Chat</h3>
                <div id="chat-messages"></div>
                <div class="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Type a message...">
                    <button id="send-chat">Send</button>
                </div>
            `;

            // Add to main menu
            mainMenu.appendChild(chatContainer);

            // Handle chat send button
            document.getElementById('send-chat').addEventListener('click', function () {
                const message = document.getElementById('chat-input').value.trim();
                if (message && currentUser) {
                    socket.emit('chatMessage', {
                        username: currentUser.username,
                        message: message
                    });
                    document.getElementById('chat-input').value = '';
                }
            });

            // Handle pressing Enter in chat input
            document.getElementById('chat-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    document.getElementById('send-chat').click();
                }
            });

            // Receive chat messages
            socket.on('chatMessage', (data) => {
                const chatMessages = document.getElementById('chat-messages');
                const messageElement = document.createElement('div');
                messageElement.className = 'chat-message';

                // Highlight current user's messages
                if (currentUser && data.username === currentUser.username) {
                    messageElement.className += ' own-message';
                }

                messageElement.innerHTML = `<strong>${data.username}:</strong> ${data.message}`;
                chatMessages.appendChild(messageElement);

                // Auto-scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });

            // Handle notification for new high scores
            socket.on('newHighScore', (data) => {
                // Create a notification
                showNotification(`${data.username} just set a new high score of ${data.score} in ${data.category}!`);
            });

            // Show a challenge button next to each player in the list
            updatePlayerListWithChallengeButtons();
        }

        // Update player list with challenge buttons
        function updatePlayerListWithChallengeButtons() {
            socket.on('playerUpdate', (data) => {
                const playerList = document.getElementById('player-list');
                playerList.innerHTML = '';

                data.players.forEach(player => {
                    if (currentUser && player !== currentUser.username) {
                        const li = document.createElement('li');
                        li.className = 'player-item';

                        const playerSpan = document.createElement('span');
                        playerSpan.textContent = player;
                        li.appendChild(playerSpan);

                        const challengeButton = document.createElement('button');
                        challengeButton.textContent = 'Challenge';
                        challengeButton.className = 'challenge-button';
                        challengeButton.onclick = function () {
                            showChallengeModal(player);
                        };

                        li.appendChild(challengeButton);
                        playerList.appendChild(li);
                    } else if (currentUser && player === currentUser.username) {
                        // Current user
                        const li = document.createElement('li');
                        li.className = 'player-item current-user';
                        li.textContent = player + ' (You)';
                        playerList.appendChild(li);
                    }
                });
            });
        }

        // Show challenge modal
        function showChallengeModal(player) {
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'challenge-modal';
            modal.innerHTML = `
                <div class="challenge-modal-content">
                    <h3>Challenge ${player}</h3>
                    <p>Select a category:</p>
                    <div class="category-buttons">
                        <button class="category-button" data-category="phishing">Phishing</button>
                        <button class="category-button" data-category="social">Social Engineering</button>
                        <button class="category-button" data-category="mobile">Mobile Security</button>
                    </div>
                    <div class="modal-buttons">
                        <button id="cancel-challenge">Cancel</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Add event listeners
            document.getElementById('cancel-challenge').addEventListener('click', function () {
                document.body.removeChild(modal);
            });

            const categoryButtons = modal.querySelectorAll('.category-button');
            categoryButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const category = this.getAttribute('data-category');
                    socket.emit('challengePlayer', {
                        target: player,
                        category: category
                    });
                    document.body.removeChild(modal);
                    showNotification(`Challenge sent to ${player}!`);
                });
            });
        }

        // Show notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;

            document.body.appendChild(notification);

            // Fade in
            setTimeout(() => {
                notification.className = 'notification show';
            }, 10);

            // Remove after 5 seconds
            setTimeout(() => {
                notification.className = 'notification';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 5000);
        }

        // Implement game achievements
        function setupAchievements() {
            // Achievement definitions
            const achievements = [
                {
                    id: 'first_game',
                    title: 'First Steps',
                    description: 'Complete your first game',
                    icon: '🎮'
                },
                {
                    id: 'perfect_score',
                    title: 'Perfect Security',
                    description: 'Get 100% on any quiz',
                    icon: '🔒'
                },
                {
                    id: 'social_master',
                    title: 'Social Engineering Expert',
                    description: 'Get at least 90% in the Social Engineering category',
                    icon: '👥'
                },
                {
                    id: 'mobile_guardian',
                    title: 'Mobile Guardian',
                    description: 'Get at least 90% in the Mobile Security category',
                    icon: '📱'
                },
                {
                    id: 'phishing_detector',
                    title: 'Phishing Detector',
                    description: 'Get at least 90% in the Phishing category',
                    icon: '🎣'
                },
                {
                    id: 'speed_demon',
                    title: 'Speed Demon',
                    description: 'Complete a quiz with at least 30 seconds remaining',
                    icon: '⏱️'
                }
            ];

            // Check achievements after game completion
            socket.on('gameCompleted', (data) => {
                checkAchievements(data);
            });

            // Check if player earned any achievements
            function checkAchievements(gameData) {
                const earnedAchievements = [];

                // Check first game achievement
                if (currentUser && currentUser.gamesPlayed === 1) {
                    earnedAchievements.push('first_game');
                }

                // Check perfect score achievement
                if (gameData.correctAnswers === gameData.totalQuestions) {
                    earnedAchievements.push('perfect_score');
                }

                // Check category-specific achievements
                if (gameData.category === 'social' && gameData.progressPercent >= 90) {
                    earnedAchievements.push('social_master');
                }

                if (gameData.category === 'mobile' && gameData.progressPercent >= 90) {
                    earnedAchievements.push('mobile_guardian');
                }

                if (gameData.category === 'phishing' && gameData.progressPercent >= 90) {
                    earnedAchievements.push('phishing_detector');
                }

                // Check speed achievement
                if (timeRemaining >= 30) {
                    earnedAchievements.push('speed_demon');
                }

                // Display earned achievements
                if (earnedAchievements.length > 0) {
                    showAchievementPopup(earnedAchievements);

                    // Send earned achievements to server
                    socket.emit('achievementsEarned', {
                        achievements: earnedAchievements
                    });
                }
            }

            // Show achievement popup
            function showAchievementPopup(achievementIds) {
                const popup = document.createElement('div');
                popup.className = 'achievement-popup';

                let popupContent = '<h3>Achievement Unlocked!</h3>';

                achievementIds.forEach(id => {
                    const achievement = achievements.find(a => a.id === id);
                    if (achievement) {
                        popupContent += `
                            <div class="achievement">
                                <div class="achievement-icon">${achievement.icon}</div>
                                <div class="achievement-info">
                                    <div class="achievement-title">${achievement.title}</div>
                                    <div class="achievement-description">${achievement.description}</div>
                                </div>
                            </div>
                        `;
                    }
                });

                popup.innerHTML = `
                    <div class="achievement-popup-content">
                        ${popupContent}
                        <button id="close-achievement">OK</button>
                    </div>
                `;

                document.body.appendChild(popup);

                // Add close button event
                document.getElementById('close-achievement').addEventListener('click', function () {
                    document.body.removeChild(popup);
                });

                // Auto close after 5 seconds
                setTimeout(() => {
                    if (document.body.contains(popup)) {
                        document.body.removeChild(popup);
                    }
                }, 5000);
            }
        }

        // Initialize multiplayer features
        function initMultiplayer() {
    // Add player list to main menu
    const playerListContainer = document.createElement('div');
    playerListContainer.id = 'online-players';
    playerListContainer.className = 'online-players-container';
    playerListContainer.innerHTML = `
        <h3>Online Players</h3>
        <ul id="player-list"></ul>
    `;
    
    const mainMenu = document.getElementById('main-menu');
    mainMenu.appendChild(playerListContainer);
    
    // Update player list when it changes
    socket.on('playerUpdate', (data) => {
        const playerList = document.getElementById('player-list');
        playerList.innerHTML = '';
        
        data.players.forEach(player => {
            const li = document.createElement('li');
            
            // Highlight current user
            if (currentUser && player === currentUser.username) {
                li.className = 'current-user';
                li.textContent = player + ' (You)';
            } else {
                li.textContent = player;
            }
            
            playerList.appendChild(li);
        });
    });
    
    // Handle socket events for multiplayer
    socket.on('gameStarted', (data) => {
        if (data.players.includes(currentUser.username)) {
            // This user is part of the match
            startGame(data.category);
        }
    });
}
    </script>
    <script src="/chat.js"></script>
</body>

</html>
